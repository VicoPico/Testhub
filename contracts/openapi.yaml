openapi: 3.0.3
info:
  title: Testhub API
  version: 0.1.0
  description: Core API for Testhub (runs, results, test cases). Auth is planned but not enforced in v0.x.

servers:
  - url: http://localhost:8080

tags:
  - name: Projects
  - name: Runs
  - name: Results
  - name: Ingestion

paths:
  /api/projects:
    get:
      tags: [Projects]
      summary: List projects visible to the current user
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Project' }

  /api/projects/{projectId}/overview:
    get:
      tags: [Projects]
      summary: Project overview stats (for dashboard)
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProjectOverview' }

  /api/projects/{projectId}/runs:
    get:
      tags: [Runs]
      summary: List test runs
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - name: cursor
          in: query
          description: Pagination cursor (opaque string)
          schema: { type: string }
        - name: status
          in: query
          schema: { $ref: '#/components/schemas/RunStatus' }
        - name: branch
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RunListResponse' }

    post:
      tags: [Ingestion]
      summary: Create a test run
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateRunRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Run' }

  /api/projects/{projectId}/runs/{runId}:
    get:
      tags: [Runs]
      summary: Get a single test run
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/RunId'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Run' }

  /api/projects/{projectId}/runs/{runId}/results:
    get:
      tags: [Results]
      summary: List results for a run
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/RunId'
        - name: status
          in: query
          schema: { $ref: '#/components/schemas/TestStatus' }
        - name: q
          in: query
          description: Simple search in test name / externalId (implementation-defined)
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 500, default: 200 }
        - name: cursor
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ResultListResponse' }

  /api/projects/{projectId}/runs/{runId}/results:batch:
    post:
      tags: [Ingestion]
      summary: Batch upsert test cases and insert results for a run
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/RunId'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BatchResultsRequest' }
      responses:
        '202':
          description: Accepted

  /api/projects/{projectId}/tests:
    get:
      tags: [Projects]
      summary: List test cases
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - name: q
          in: query
          schema: { type: string }
        - name: tag
          in: query
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
        - name: cursor
          in: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/TestCase' }
                  nextCursor:
                    type: string
                    nullable: true

components:
  parameters:
    ProjectId:
      name: projectId
      in: path
      required: true
      schema: { type: string }
    RunId:
      name: runId
      in: path
      required: true
      schema: { type: string }

  schemas:
    RunStatus:
      type: string
      enum: [QUEUED, RUNNING, COMPLETED, FAILED, CANCELED]

    TestStatus:
      type: string
      enum: [PASSED, FAILED, SKIPPED, ERROR]

    Project:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        slug: { type: string }

    ProjectOverview:
      type: object
      properties:
        projectId: { type: string }
        latestRun: { $ref: '#/components/schemas/Run', nullable: true }
        stats:
          type: object
          properties:
            last7Days:
              $ref: '#/components/schemas/RunTotals'
            last30Days:
              $ref: '#/components/schemas/RunTotals'

    RunTotals:
      type: object
      properties:
        totalCount: { type: integer }
        passedCount: { type: integer }
        failedCount: { type: integer }
        skippedCount: { type: integer }
        errorCount: { type: integer }

    Run:
      type: object
      properties:
        id: { type: string }
        projectId: { type: string }
        status: { $ref: '#/components/schemas/RunStatus' }
        source: { type: string, nullable: true }
        commitSha: { type: string, nullable: true }
        branch: { type: string, nullable: true }
        startedAt: { type: string, format: date-time, nullable: true }
        finishedAt: { type: string, format: date-time, nullable: true }
        durationMs: { type: integer, nullable: true }
        env:
          type: object
          additionalProperties: true
          nullable: true
        meta:
          type: object
          additionalProperties: true
          nullable: true
        totals: { $ref: '#/components/schemas/RunTotals' }

    RunListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Run' }
        nextCursor:
          type: string
          nullable: true

    TestCase:
      type: object
      properties:
        id: { type: string }
        projectId: { type: string }
        externalId: { type: string }
        name: { type: string }
        filePath: { type: string, nullable: true }
        suiteName: { type: string, nullable: true }
        tags:
          type: array
          items: { type: string }

    Result:
      type: object
      properties:
        id: { type: string }
        runId: { type: string }
        testCase:
          $ref: '#/components/schemas/TestCase'
        status: { $ref: '#/components/schemas/TestStatus' }
        durationMs: { type: integer, nullable: true }
        message: { type: string, nullable: true }
        stacktrace: { type: string, nullable: true }
        stdout: { type: string, nullable: true }
        stderr: { type: string, nullable: true }
        meta:
          type: object
          additionalProperties: true
          nullable: true

    ResultListResponse:
      type: object
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/Result' }
        nextCursor:
          type: string
          nullable: true

    CreateRunRequest:
      type: object
      required: [status]
      properties:
        status: { $ref: '#/components/schemas/RunStatus' }
        source: { type: string }
        commitSha: { type: string }
        branch: { type: string }
        startedAt: { type: string, format: date-time }
        env:
          type: object
          additionalProperties: true
        meta:
          type: object
          additionalProperties: true

    BatchResultsRequest:
      type: object
      required: [items]
      properties:
        items:
          type: array
          minItems: 1
          items:
            type: object
            required: [externalId, name, status]
            properties:
              externalId: { type: string }
              name: { type: string }
              filePath: { type: string }
              suiteName: { type: string }
              tags:
                type: array
                items: { type: string }
              status: { $ref: '#/components/schemas/TestStatus' }
              durationMs: { type: integer }
              message: { type: string }
              stacktrace: { type: string }
              stdout: { type: string }
              stderr: { type: string }
              meta:
                type: object
                additionalProperties: true
